{"version":3,"file":"session-worker.js","names":["_sessionDatabase","_interopRequireDefault","obj","__esModule","default","SessionWorker","_proto","prototype","exportToObject","initInstance","bind","post","sessions","instance","database","SessionDatabase","Promise","resolve","event","postRecord","then","offset","limit","getFullSnapshotsWithMeta","items","splice","reduce","accumulator","currentValue","_accumulator$pop","snapshotMeta","pop","snapshot","meta","push","type","EventType","Meta","FullSnapshot","filter","it","forEach","_tagMetaTitle$attribu","_tagMetaTitle$attribu2","tagMetaTitle","data","node","childNodes","find","tagName","_it$attributes","attributes","name","timestamp","href","title","content","sessionWorker","expose"],"sources":["../../ts/js/worker/session-worker.ts"],"sourcesContent":["import {expose} from 'threads/worker';\nimport {\n    EventType,\n    RecordEvent,\n    RecordSession,\n    SessionWorker as SessionWorkerInterface,\n    SnapshotWithMeta\n} from 'VMPL_BugReplay/js/api/session'\nimport SessionDatabase from \"VMPL_BugReplay/js/lib/session-database\";\n\nclass SessionWorker implements SessionWorkerInterface {\n    protected database: SessionDatabase;\n\n    exportToObject(): Object {\n        return {\n            initInstance: this.initInstance.bind(this),\n            post: this.post.bind(this),\n            sessions: this.sessions.bind(this),\n        }\n    }\n\n    initInstance(instance: string): Promise<any> {\n        this.database = new SessionDatabase(instance);\n        return Promise.resolve();\n    }\n\n    post(event: RecordEvent): Promise<boolean> {\n        return this.database.postRecord(event)\n            .then(() => true);\n    }\n\n    sessions(offset: number = 0, limit: number): Promise<any[]> {\n        return this.database.getFullSnapshotsWithMeta()\n            .then(items => {\n                const sessions: any[] = [];\n                items\n                    .splice(offset * 2, limit * 2)\n                    .reduce<SnapshotWithMeta[]>((accumulator, currentValue) => {\n                        let snapshotMeta: SnapshotWithMeta = accumulator.pop() ?? {snapshot: null, meta: null};\n                        if (snapshotMeta.meta !== null && snapshotMeta.snapshot !== null) {\n                            accumulator.push(snapshotMeta);\n                            snapshotMeta = {snapshot: null, meta: null};\n                        }\n\n                        switch (true) {\n                            case currentValue.type === EventType.Meta && snapshotMeta.meta === null:\n                                snapshotMeta.meta = currentValue;\n                                break;\n                            case currentValue.type === EventType.FullSnapshot && snapshotMeta.snapshot === null:\n                                snapshotMeta.snapshot = currentValue;\n                                break;\n                            default:\n                                break;\n                        }\n\n                        accumulator.push(snapshotMeta);\n                        return accumulator;\n                    }, [])\n                    .filter(it => !(it.meta === null || it.snapshot === null))\n                    .forEach((snapshotMeta: SnapshotWithMeta) => {\n                        const tagMetaTitle = snapshotMeta.snapshot.data.node\n                            .childNodes.find((it: any) => it.tagName === 'html')\n                            .childNodes.find((it: any) => it.tagName === 'head')\n                            .childNodes.find((it: any) => it.attributes?.name === 'title')\n\n                        sessions.push({\n                            timestamp: snapshotMeta.meta.timestamp,\n                            href: snapshotMeta.meta.data.href,\n                            title: tagMetaTitle?.attributes?.content ?? 'Unknown',\n                        })\n                    })\n\n                return sessions;\n            })\n    }\n}\n\nconst sessionWorker = new SessionWorker();\nexpose(sessionWorker.exportToObject());\n"],"mappings":"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"}