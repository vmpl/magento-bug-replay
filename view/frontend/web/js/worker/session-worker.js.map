{"version":3,"file":"session-worker.js","names":["_sessionDatabase","_interopRequireDefault","_workerSerializer","_class","obj","__esModule","default","_applyDecoratedDescriptor","target","property","decorators","descriptor","context","desc","Object","keys","forEach","key","enumerable","configurable","initializer","writable","slice","reverse","reduce","decorator","value","call","undefined","defineProperty","SessionWorker","_proto","prototype","initInstance","instance","database","SessionDatabase","Promise","resolve","post","event","postRecord","then","sessions","offset","limit","filter","getFullSnapshotsWithMeta","items","_filter$match","accumulator","currentValue","_accumulator$pop","snapshotMeta","pop","snapshot","meta","push","type","EventType","Meta","FullSnapshot","it","_tagMetaTitle$attribu","_tagMetaTitle$attribu2","tagMetaTitle","data","node","childNodes","find","tagName","_it$attributes","attributes","name","timestamp","href","title","content","match","totalRecords","length","exportToObject","getOwnPropertyDescriptor","registerSerializer","WorkerSerializer","sessionWorker","expose","$exportObject"],"sources":["../../ts/js/worker/session-worker.ts"],"sourcesContent":["// @ts-ignore\nimport {expose, registerSerializer} from 'threads/worker';\nimport {\n    EventType,\n    IRecordEvent,\n    SessionWorker as SessionWorkerInterface,\n    SnapshotWithMeta\n} from 'VMPL_BugReplay/js/api/session'\nimport SessionDatabase from \"VMPL_BugReplay/js/lib/session-database\";\nimport {IPaginatorFilter, IPaginatorResponse} from \"VMPL_BugReplay/js/api/paginator\";\nimport WorkerSerializer from \"VMPL_BugReplay/js/lib/worker-serializer\";\nimport {exportToObject} from \"VMPL_BugReplay/js/lib/decorator/worker-class\";\n\nclass SessionWorker implements SessionWorkerInterface {\n    protected database: SessionDatabase;\n\n    @exportToObject\n    initInstance(instance: string): Promise<any> {\n        this.database = new SessionDatabase(instance);\n        return Promise.resolve();\n    }\n\n    @exportToObject\n    post(event: IRecordEvent): Promise<boolean> {\n        return this.database.postRecord(event)\n            .then(() => true);\n    }\n\n    @exportToObject\n    sessions(offset: number = 0, limit: number, filter: IPaginatorFilter): Promise<IPaginatorResponse> {\n        return this.database.getFullSnapshotsWithMeta()\n            .then(items => {\n                let sessions: any[] = [];\n                items\n                    .reduce<SnapshotWithMeta[]>((accumulator, currentValue) => {\n                        let snapshotMeta: SnapshotWithMeta = accumulator.pop() ?? {snapshot: null, meta: null};\n                        if (snapshotMeta.meta !== null && snapshotMeta.snapshot !== null) {\n                            accumulator.push(snapshotMeta);\n                            snapshotMeta = {snapshot: null, meta: null};\n                        }\n\n                        switch (true) {\n                            case currentValue.type === EventType.Meta && snapshotMeta.meta === null:\n                                snapshotMeta.meta = currentValue;\n                                break;\n                            case currentValue.type === EventType.FullSnapshot && snapshotMeta.snapshot === null:\n                                snapshotMeta.snapshot = currentValue;\n                                break;\n                            default:\n                                break;\n                        }\n\n                        accumulator.push(snapshotMeta);\n                        return accumulator;\n                    }, [])\n                    .filter(it => !(it.meta === null || it.snapshot === null))\n                    .forEach((snapshotMeta: SnapshotWithMeta) => {\n                        const tagMetaTitle = snapshotMeta.snapshot.data.node\n                            .childNodes.find((it: any) => it.tagName === 'html')\n                            .childNodes.find((it: any) => it.tagName === 'head')\n                            .childNodes.find((it: any) => it.attributes?.name === 'title')\n\n                        sessions.push({\n                            timestamp: snapshotMeta.meta.timestamp,\n                            href: snapshotMeta.meta.data.href,\n                            title: tagMetaTitle?.attributes?.content ?? 'Unknown',\n                        })\n                    })\n\n                sessions = filter?.match(sessions) ?? sessions;\n                return {\n                    meta: {totalRecords: sessions.length},\n                    items: sessions\n                }\n            })\n    }\n}\nregisterSerializer(WorkerSerializer);\n\nconst sessionWorker = new SessionWorker();\n// @ts-ignore\nexpose(sessionWorker.$exportObject());\n"],"mappings":"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"}