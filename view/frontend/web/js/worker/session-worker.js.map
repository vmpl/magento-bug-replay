{"version":3,"file":"session-worker.js","names":["_sessionDatabase","_interopRequireDefault","_dec","_class","obj","__esModule","default","SessionWorker","WorkerConsumer","_proto","prototype","initInstance","instance","database","SessionDatabase","Promise","resolve","post","event","postRecord","then","sessions","offset","limit","filter","getFullSnapshotsWithMeta","items","_filter$match","reduce","accumulator","currentValue","_accumulator$pop","snapshotMeta","pop","snapshot","meta","push","type","EventType","Meta","FullSnapshot","it","forEach","_tagMetaTitle$attribu","_tagMetaTitle$attribu2","tagMetaTitle","data","node","childNodes","find","tagName","_it$attributes","attributes","name","timestamp","href","title","content","match","totalRecords","length"],"sources":["../../ts/js/worker/session-worker.ts"],"sourcesContent":["import {\n    EventType,\n    IRecordEvent,\n    SessionWorker as SessionWorkerInterface,\n    SnapshotWithMeta\n} from 'VMPL_BugReplay/js/api/session'\nimport SessionDatabase from \"VMPL_BugReplay/js/lib/session-database\";\nimport {IPaginatorFilter, IPaginatorResponse} from \"VMPL_BugReplay/js/api/paginator\";\nimport {WorkerConsumer} from \"VMPL_BugReplay/js/lib/worker/consumer\";\n\n@WorkerConsumer()\nclass SessionWorker implements SessionWorkerInterface {\n    protected database: SessionDatabase;\n\n    initInstance(instance: string): Promise<any> {\n        this.database = new SessionDatabase(instance);\n        return Promise.resolve();\n    }\n\n    post(event: IRecordEvent): Promise<boolean> {\n        return this.database.postRecord(event)\n            .then(() => true);\n    }\n\n    sessions(offset: number = 0, limit: number, filter: IPaginatorFilter): Promise<IPaginatorResponse> {\n        return this.database.getFullSnapshotsWithMeta()\n            .then(items => {\n                let sessions: any[] = [];\n                items\n                    .reduce<SnapshotWithMeta[]>((accumulator, currentValue) => {\n                        let snapshotMeta: SnapshotWithMeta = accumulator.pop() ?? {snapshot: null, meta: null};\n                        if (snapshotMeta.meta !== null && snapshotMeta.snapshot !== null) {\n                            accumulator.push(snapshotMeta);\n                            snapshotMeta = {snapshot: null, meta: null};\n                        }\n\n                        switch (true) {\n                            case currentValue.type === EventType.Meta && snapshotMeta.meta === null:\n                                snapshotMeta.meta = currentValue;\n                                break;\n                            case currentValue.type === EventType.FullSnapshot && snapshotMeta.snapshot === null:\n                                snapshotMeta.snapshot = currentValue;\n                                break;\n                            default:\n                                break;\n                        }\n\n                        accumulator.push(snapshotMeta);\n                        return accumulator;\n                    }, [])\n                    .filter(it => !(it.meta === null || it.snapshot === null))\n                    .forEach((snapshotMeta: SnapshotWithMeta) => {\n                        const tagMetaTitle = snapshotMeta.snapshot.data.node\n                            .childNodes.find((it: any) => it.tagName === 'html')\n                            .childNodes.find((it: any) => it.tagName === 'head')\n                            .childNodes.find((it: any) => it.attributes?.name === 'title')\n\n                        sessions.push({\n                            timestamp: snapshotMeta.meta.timestamp,\n                            href: snapshotMeta.meta.data.href,\n                            title: tagMetaTitle?.attributes?.content ?? 'Unknown',\n                        })\n                    })\n\n                sessions = filter?.match(sessions) ?? sessions;\n                return {\n                    meta: {totalRecords: sessions.length},\n                    items: sessions\n                }\n            })\n    }\n}\n\n(new SessionWorker());\n"],"mappings":"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"}