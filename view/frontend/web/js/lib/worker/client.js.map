{"version":3,"file":"client.js","names":["ClientEvent","_Event","_inheritsLoose","type","data","eventInitDict","_this","call","_wrapNativeSuper","Event","Client","worker","dispatcher","EventTarget","addEventListener","onMessage","bind","init","instance","Promise","resolve","event","entries","map","method","_len","arguments","length","args","Array","_key","postMessage","Object","fromEntries","once","_proto","prototype","_this2","_converter","objectToClass","result","then","id","dispatchEvent","_this3","uuid","all","classToObject","resolved","WorkerClient","scriptUrl","Worker","client"],"sources":["../../../ts/js/lib/worker/client.ts"],"sourcesContent":["import {IMethodWorker, IResultWorker} from \"VMPL_BugReplay/js/api/worker\";\nimport Converter from \"VMPL_BugReplay/js/lib/worker/converter\";\nimport {v4 as uuid} from 'uuid';\n\nclass ClientEvent extends Event {\n    constructor(\n        type: string,\n        public readonly data: any,\n        eventInitDict?: EventInit,\n    ) {\n        super(type, eventInitDict);\n    }\n}\n\nclass Client {\n    protected constructor(\n        public readonly worker: Worker,\n        protected readonly dispatcher = new EventTarget(),\n    ) {\n        this.worker.addEventListener('message', this.onMessage.bind(this));\n    }\n\n    static init(worker: Worker): Promise<Object> {\n        const instance = new Client(worker);\n        return new Promise(resolve => {\n            instance.dispatcher.addEventListener('$$init', (event: ClientEvent) => {\n                const entries = (<string[]>event.data)\n                    .map(method => {\n                        return [method, (...args: any[]) => (instance.postMessage(method, args))];\n                    })\n\n                resolve(Object.fromEntries(entries))\n            }, {once: true});\n        })\n    }\n\n    protected onMessage(event: MessageEvent<IResultWorker>) {\n        Converter.objectToClass(event.data.result)\n            .then(result => new ClientEvent(event.data.id, result))\n            .then(event => this.dispatcher.dispatchEvent(event))\n    }\n\n    protected postMessage(method: string, args: any[]): Promise<any> {\n        const id = uuid();\n        Promise.all(args.map(Converter.classToObject.bind(Converter)))\n            .then(resolved => this.worker.postMessage(<IMethodWorker>{\n                id,\n                method,\n                arguments: resolved,\n            }));\n\n        return new Promise(resolve => {\n            this.dispatcher.addEventListener(id, (event: ClientEvent) => {\n                resolve(event.data);\n            }, {once: true});\n        });\n    }\n}\n\nexport function WorkerClient<T extends Object>(scriptUrl: string): Promise<T> {\n    return Client.init(new Worker(scriptUrl))\n        .then((client: T) => client);\n}\n"],"mappings":"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"}