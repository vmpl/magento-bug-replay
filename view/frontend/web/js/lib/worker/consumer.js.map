{"version":3,"file":"consumer.js","names":["WorkerConsumer","namespace","WorkerGlobalScope","Error","target","_target","_inheritsLoose","_class","_this","_len","arguments","length","args","Array","_key","call","run","_proto","prototype","$$messageHandler","event","_this2","hasOwnProperty","data","method","Promise","all","map","_converter","objectToClass","bind","then","apply","result","classToObject","postMessage","id","catch","error","methods","Object","entries","getOwnPropertyDescriptors","filter","_ref","property","descriptor","value","Function","_ref2","addEventListener"],"sources":["../../../ts/js/lib/worker/consumer.ts"],"sourcesContent":["import {IMethodWorker, IResultWorker, IWebWorker} from \"VMPL_BugReplay/js/api/worker\";\nimport Converter from \"VMPL_BugReplay/js/lib/worker/converter\";\n\nexport function WorkerConsumer(namespace: string = null) {\n    if (!WorkerGlobalScope) {\n        throw new Error(`Can only register on worker.`)\n    }\n\n    return function <T extends IWebWorker>(target: T) {\n        return class extends target {\n            constructor(...args: any[]) {\n                super(args);\n                this.run();\n            }\n\n            $$messageHandler(event: MessageEvent<IMethodWorker>) {\n                if (!target.prototype.hasOwnProperty(event.data.method)) {\n                    return;\n                }\n\n                Promise.all(event.data.arguments.map(Converter.objectToClass.bind(Converter)))\n                    .then((args: any[]) => {\n                        return target.prototype[event.data.method].apply(this, args);\n                    })\n                    .then(result => Converter.classToObject(result))\n                    .then(data => postMessage(<IResultWorker>{\n                        id: event.data.id,\n                        method: event.data.method,\n                        result: data\n                    }))\n                    .catch(error => {\n                        throw error;\n                    })\n            }\n\n            run(): void {\n                const methods = Object.entries(Object.getOwnPropertyDescriptors(target.prototype))\n                    .filter(([property, descriptor]) => {\n                        return descriptor.value instanceof Function;\n                    })\n                    .map(([property]) => property);\n\n                postMessage(<IResultWorker>{\n                    id: '$$init',\n                    method: '$$init',\n                    result: methods\n                });\n\n                addEventListener('message', this.$$messageHandler.bind(this));\n            }\n        }\n    }\n}\n"],"mappings":";;;;;EAGO,SAASA,cAAcA,CAACC,SAAiB,EAAS;IAAA,IAA1BA,SAAiB;MAAjBA,SAAiB,GAAG,IAAI;IAAA;IACnD,IAAI,CAACC,iBAAiB,EAAE;MACpB,MAAM,IAAIC,KAAK,+BAA+B,CAAC;IACnD;IAEA,OAAO,UAAgCC,MAAS,EAAE;MAC9C,8BAAAC,OAAA;QAAA;;QAAAC,cAAA,CAAAC,MAAA,EAAAF,OAAA;QACI,SAAAE,OAAA,EAA4B;UAAA,IAAAC,KAAA;UAAA,SAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAAbC,IAAI,OAAAC,KAAA,CAAAJ,IAAA,GAAAK,IAAA,MAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA;YAAJF,IAAI,CAAAE,IAAA,IAAAJ,SAAA,CAAAI,IAAA;UAAA;UACfN,KAAA,GAAAH,OAAA,CAAAU,IAAA,OAAMH,IAAI,CAAC;UACXJ,KAAA,CAAKQ,GAAG,CAAC,CAAC;UAAC,OAAAR,KAAA;QACf;QAAC,IAAAS,MAAA,GAAAV,MAAA,CAAAW,SAAA;QAAAD,MAAA,CAEDE,gBAAgB,GAAhB,SAAAA,iBAAiBC,KAAkC,EAAE;UAAA,IAAAC,MAAA;UACjD,IAAI,CAACjB,MAAM,CAACc,SAAS,CAACI,cAAc,CAACF,KAAK,CAACG,IAAI,CAACC,MAAM,CAAC,EAAE;YACrD;UACJ;UAEAC,OAAO,CAACC,GAAG,CAACN,KAAK,CAACG,IAAI,CAACb,SAAS,CAACiB,GAAG,CAACC,UAAA,CAAUC,aAAa,CAACC,IAAI,CAAAF,UAAU,CAAC,CAAC,CAAC,CACzEG,IAAI,CAAC,UAACnB,IAAW,EAAK;YACnB,OAAOR,MAAM,CAACc,SAAS,CAACE,KAAK,CAACG,IAAI,CAACC,MAAM,CAAC,CAACQ,KAAK,CAACX,MAAI,EAAET,IAAI,CAAC;UAChE,CAAC,CAAC,CACDmB,IAAI,CAAC,UAAAE,MAAM;YAAA,OAAIL,UAAA,CAAUM,aAAa,CAACD,MAAM,CAAC;UAAA,EAAC,CAC/CF,IAAI,CAAC,UAAAR,IAAI;YAAA,OAAIY,WAAW,CAAgB;cACrCC,EAAE,EAAEhB,KAAK,CAACG,IAAI,CAACa,EAAE;cACjBZ,MAAM,EAAEJ,KAAK,CAACG,IAAI,CAACC,MAAM;cACzBS,MAAM,EAAEV;YACZ,CAAC,CAAC;UAAA,EAAC,CACFc,KAAK,CAAC,UAAAC,KAAK,EAAI;YACZ,MAAMA,KAAK;UACf,CAAC,CAAC;QACV,CAAC;QAAArB,MAAA,CAEDD,GAAG,GAAH,SAAAA,IAAA,EAAY;UACR,IAAMuB,OAAO,GAAGC,MAAM,CAACC,OAAO,CAACD,MAAM,CAACE,yBAAyB,CAACtC,MAAM,CAACc,SAAS,CAAC,CAAC,CAC7EyB,MAAM,CAAC,UAAAC,IAAA,EAA4B;YAAA,IAA1BC,QAAQ,GAAAD,IAAA;cAAEE,UAAU,GAAAF,IAAA;YAC1B,OAAOE,UAAU,CAACC,KAAK,YAAYC,QAAQ;UAC/C,CAAC,CAAC,CACDrB,GAAG,CAAC,UAAAsB,KAAA;YAAA,IAAEJ,QAAQ,GAAAI,KAAA;YAAA,OAAMJ,QAAQ;UAAA,EAAC;UAElCV,WAAW,CAAgB;YACvBC,EAAE,EAAE,QAAQ;YACZZ,MAAM,EAAE,QAAQ;YAChBS,MAAM,EAAEM;UACZ,CAAC,CAAC;UAEFW,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC/B,gBAAgB,CAACW,IAAI,CAAC,IAAI,CAAC,CAAC;QACjE,CAAC;QAAA,OAAAvB,MAAA;MAAA,EAxCgBH,MAAM;IA0C/B,CAAC;EACL;EAAC;IAAAJ,cAAA,EAAAA;EAAA;AAAA"}