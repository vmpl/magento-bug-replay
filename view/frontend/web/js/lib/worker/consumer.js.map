{"version":3,"file":"consumer.js","names":["WorkerConsumer","namespace","WorkerGlobalScope","Error","target","_target","_inheritsLoose","_class","_this","_len","arguments","length","args","Array","_key","call","run","_proto","prototype","$$messageHandler","event","_this2","hasOwnProperty","data","method","Promise","all","map","it","_converter","objectToClass","then","apply","result","postMessage","catch","error","console","addEventListener","bind","methods","Object","entries","getOwnPropertyDescriptors","filter","_ref","property","descriptor","value","Function","_ref2"],"sources":["../../../ts/js/lib/worker/consumer.ts"],"sourcesContent":["import {IMessageWorker, IWebWorker} from \"VMPL_BugReplay/js/lib/worker/api\";\nimport Converter from \"VMPL_BugReplay/js/lib/worker/converter\";\n\nexport function WorkerConsumer(namespace: string = null) {\n    if (!WorkerGlobalScope) {\n        throw new Error(`Can only register on worker.`)\n    }\n\n    return function <T extends IWebWorker>(target: T) {\n        return class extends target {\n            constructor(...args: any[]) {\n                super(args);\n                this.run();\n            }\n\n            $$messageHandler(event: MessageEvent<IMessageWorker>) {\n                if (!target.prototype.hasOwnProperty(event.data.method)) {\n                    return;\n                }\n\n                Promise.all(event.data.arguments.map(it => Converter.objectToClass(it)))\n                    .then((args: any[]) => {\n                        return target.prototype[event.data.method].apply(this, args);\n                    })\n                    .then(result => postMessage(result))\n                    .catch(error => {\n                        console.error(error);\n                        throw error;\n                    })\n            }\n\n            run(): void {\n                addEventListener('message', this.$$messageHandler.bind(this));\n\n                const methods = Object.entries(Object.getOwnPropertyDescriptors(target.prototype))\n                    .filter(([property, descriptor]) => {\n                        return descriptor.value instanceof Function;\n                    })\n                    .map(([property]) => property);\n\n                postMessage(<IMessageWorker>{\n                    method: '$$init',\n                    arguments: methods\n                });\n            }\n        }\n    }\n}\n"],"mappings":";;;;;EAGO,SAASA,cAAcA,CAACC,SAAiB,EAAS;IAAA,IAA1BA,SAAiB;MAAjBA,SAAiB,GAAG,IAAI;IAAA;IACnD,IAAI,CAACC,iBAAiB,EAAE;MACpB,MAAM,IAAIC,KAAK,+BAA+B,CAAC;IACnD;IAEA,OAAO,UAAgCC,MAAS,EAAE;MAC9C,8BAAAC,OAAA;QAAA;;QAAAC,cAAA,CAAAC,MAAA,EAAAF,OAAA;QACI,SAAAE,OAAA,EAA4B;UAAA,IAAAC,KAAA;UAAA,SAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAAbC,IAAI,OAAAC,KAAA,CAAAJ,IAAA,GAAAK,IAAA,MAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA;YAAJF,IAAI,CAAAE,IAAA,IAAAJ,SAAA,CAAAI,IAAA;UAAA;UACfN,KAAA,GAAAH,OAAA,CAAAU,IAAA,OAAMH,IAAI,CAAC;UACXJ,KAAA,CAAKQ,GAAG,CAAC,CAAC;UAAC,OAAAR,KAAA;QACf;QAAC,IAAAS,MAAA,GAAAV,MAAA,CAAAW,SAAA;QAAAD,MAAA,CAEDE,gBAAgB,GAAhB,SAAAA,iBAAiBC,KAAmC,EAAE;UAAA,IAAAC,MAAA;UAClD,IAAI,CAACjB,MAAM,CAACc,SAAS,CAACI,cAAc,CAACF,KAAK,CAACG,IAAI,CAACC,MAAM,CAAC,EAAE;YACrD;UACJ;UAEAC,OAAO,CAACC,GAAG,CAACN,KAAK,CAACG,IAAI,CAACb,SAAS,CAACiB,GAAG,CAAC,UAAAC,EAAE;YAAA,OAAIC,UAAA,CAAUC,aAAa,CAACF,EAAE,CAAC;UAAA,EAAC,CAAC,CACnEG,IAAI,CAAC,UAACnB,IAAW,EAAK;YACnB,OAAOR,MAAM,CAACc,SAAS,CAACE,KAAK,CAACG,IAAI,CAACC,MAAM,CAAC,CAACQ,KAAK,CAACX,MAAI,EAAET,IAAI,CAAC;UAChE,CAAC,CAAC,CACDmB,IAAI,CAAC,UAAAE,MAAM;YAAA,OAAIC,WAAW,CAACD,MAAM,CAAC;UAAA,EAAC,CACnCE,KAAK,CAAC,UAAAC,KAAK,EAAI;YACZC,OAAO,CAACD,KAAK,CAACA,KAAK,CAAC;YACpB,MAAMA,KAAK;UACf,CAAC,CAAC;QACV,CAAC;QAAAnB,MAAA,CAEDD,GAAG,GAAH,SAAAA,IAAA,EAAY;UACRsB,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAACnB,gBAAgB,CAACoB,IAAI,CAAC,IAAI,CAAC,CAAC;UAE7D,IAAMC,OAAO,GAAGC,MAAM,CAACC,OAAO,CAACD,MAAM,CAACE,yBAAyB,CAACvC,MAAM,CAACc,SAAS,CAAC,CAAC,CAC7E0B,MAAM,CAAC,UAAAC,IAAA,EAA4B;YAAA,IAA1BC,QAAQ,GAAAD,IAAA;cAAEE,UAAU,GAAAF,IAAA;YAC1B,OAAOE,UAAU,CAACC,KAAK,YAAYC,QAAQ;UAC/C,CAAC,CAAC,CACDtB,GAAG,CAAC,UAAAuB,KAAA;YAAA,IAAEJ,QAAQ,GAAAI,KAAA;YAAA,OAAMJ,QAAQ;UAAA,EAAC;UAElCZ,WAAW,CAAiB;YACxBV,MAAM,EAAE,QAAQ;YAChBd,SAAS,EAAE8B;UACf,CAAC,CAAC;QACN,CAAC;QAAA,OAAAjC,MAAA;MAAA,EAnCgBH,MAAM;IAqC/B,CAAC;EACL;EAAC;IAAAJ,cAAA,EAAAA;EAAA;AAAA"}