{"version":3,"file":"worker.js","names":["_database","_interopRequireDefault","_dec","_class","obj","__esModule","default","Worker","WorkerConsumer","_proto","prototype","initInstance","instance","database","SessionDatabase","Promise","resolve","post","event","postRecord","then","sessions","offset","limit","filter","getFullSnapshotsWithMeta","items","_filter$match","reduce","accumulator","currentValue","_accumulator$pop","snapshotMeta","pop","snapshot","meta","push","type","EventType","Meta","FullSnapshot","it","forEach","_tagMetaTitle$attribu","_tagMetaTitle$attribu2","tagMetaTitle","data","node","childNodes","find","tagName","_it$attributes","attributes","name","RecordSession","URL","href","content","Date","timestamp","match","totalRecords","length","slice","events","_this","all","map","session","getEvents","getTime","_ref","concat","apply","sort","a","b","export","_export","_sorted$shift","_sorted$pop","sorted","fromDate","shift","toDate","exportSessions"],"sources":["../../../ts/js/lib/session/worker.ts"],"sourcesContent":["import {\n    EventType,\n    IRecordEvent, IRecordSession,\n    SessionWorker as SessionWorkerInterface,\n    SnapshotWithMeta\n} from 'VMPL_BugReplay/js/api/session'\nimport SessionDatabase from \"VMPL_BugReplay/js/lib/session/database\";\nimport {IPaginatorFilter, IPaginatorResponse} from \"VMPL_BugReplay/js/api/paginator\";\nimport {WorkerConsumer} from \"VMPL_BugReplay/js/lib/worker/consumer\";\nimport {RecordSession} from \"VMPL_BugReplay/js/lib/session/model/record-session\";\n\n@WorkerConsumer()\nclass Worker implements SessionWorkerInterface {\n    protected database: SessionDatabase;\n\n    initInstance(instance: string): Promise<void> {\n        this.database = new SessionDatabase(instance);\n        return Promise.resolve();\n    }\n\n    post(event: IRecordEvent): Promise<boolean> {\n        return this.database.postRecord(event)\n            .then(() => true);\n    }\n\n    sessions(\n        offset: number = 0,\n        limit: number, filter: IPaginatorFilter<IRecordSession>\n    ): Promise<IPaginatorResponse<IRecordSession>> {\n        return this.database.getFullSnapshotsWithMeta()\n            .then(items => {\n                let sessions: any[] = [];\n                items\n                    .reduce<SnapshotWithMeta[]>((accumulator, currentValue) => {\n                        let snapshotMeta: SnapshotWithMeta = accumulator.pop() ?? {snapshot: null, meta: null};\n                        if (snapshotMeta.meta !== null && snapshotMeta.snapshot !== null) {\n                            accumulator.push(snapshotMeta);\n                            snapshotMeta = {snapshot: null, meta: null};\n                        }\n\n                        switch (true) {\n                            case currentValue.type === EventType.Meta && snapshotMeta.meta === null:\n                                snapshotMeta.meta = currentValue;\n                                break;\n                            case currentValue.type === EventType.FullSnapshot && snapshotMeta.snapshot === null:\n                                snapshotMeta.snapshot = currentValue;\n                                break;\n                            default:\n                                break;\n                        }\n\n                        accumulator.push(snapshotMeta);\n                        return accumulator;\n                    }, [])\n                    .filter(it => !(it.meta === null || it.snapshot === null))\n                    .forEach((snapshotMeta: SnapshotWithMeta) => {\n                        const tagMetaTitle = snapshotMeta.snapshot.data.node\n                            .childNodes.find((it: any) => it.tagName === 'html')\n                            .childNodes.find((it: any) => it.tagName === 'head')\n                            .childNodes.find((it: any) => it.attributes?.name === 'title')\n\n                        sessions.push(new RecordSession(\n                            new URL(snapshotMeta.meta.data.href),\n                            tagMetaTitle?.attributes?.content ?? 'Unknown',\n                            new Date(snapshotMeta.meta.timestamp),\n                        ))\n                    })\n\n                sessions = filter?.match(sessions) ?? sessions;\n                return {\n                    meta: {totalRecords: sessions.length},\n                    items: sessions.slice(offset, limit)\n                }\n            })\n    }\n\n    events(sessions: IRecordSession[]): Promise<IPaginatorResponse<IRecordEvent>> {\n        return Promise.all(sessions.map(session => this.database.getEvents(session.timestamp.getTime())))\n            .then(events => {\n                const items = <IRecordEvent[]>[].concat(...events);\n                // @ts-ignore\n                items.sort((a, b) => a.timestamp > b.timestamp)\n                return {\n                    items: items,\n                    meta: {\n                        totalRecords: items.length,\n                    }\n                }\n            })\n    }\n\n    export(sessions?: IRecordSession[]): Promise<Blob> {\n        // @ts-ignore\n        const sorted = (sessions ?? []).sort(it => it.timestamp.getTime() < it.timestamp.getTime());\n        const fromDate = sorted.shift()?.timestamp;\n        const toDate = sorted.pop()?.timestamp;\n\n        return this.database.exportSessions(fromDate, toDate);\n    }\n}\n\n(new Worker());\n"],"mappings":"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"}