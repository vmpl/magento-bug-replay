{"version":3,"file":"database.js","names":["Database","_dexie$Dexie","_inheritsLoose","databaseName","_this","call","counter","version","stores","events","mapToClass","RecordEvent","_proto","prototype","postRecord","record","put","getFullSnapshotsWithMeta","types","Array","of","EventType","FullSnapshot","valueOf","Meta","orderBy","reverse","filter","it","indexOf","type","toArray","getEvents","timestamp","_this2","limit","first","then","nextSession","_nextSession$timestam","Number","MAX_VALUE","exportSessions","fromDate","toDate","exportDB","table","value","key","getTime","MIN_VALUE","Dexie"],"sources":["../../../ts/js/lib/session/database.ts"],"sourcesContent":["import {Dexie} from \"dexie\";\nimport {exportDB} from \"dexie-export-import\";\nimport {EventType, IRecordEvent} from \"VMPL_BugReplay/js/api/session\";\nimport {RecordEvent} from \"VMPL_BugReplay/js/lib/session/model/record-event\";\n\nexport default class Database extends Dexie {\n    events!: Dexie.Table<IRecordEvent, number>;\n\n    constructor(databaseName: string) {\n        super(databaseName);\n        let counter: number = 0;\n        this.version(++counter).stores({\n            events: '&timestamp,*type,data',\n        })\n        this.events.mapToClass(RecordEvent);\n    }\n\n    postRecord(record: IRecordEvent): Promise<number> {\n        return this.events.put(record);\n    }\n\n    getFullSnapshotsWithMeta(): Promise<IRecordEvent[]> {\n        const types: number[] = Array.of(EventType.FullSnapshot.valueOf(), EventType.Meta.valueOf());\n        return this.events\n            .orderBy('timestamp').reverse()\n            .filter(it => types.indexOf(it?.type.valueOf()) !== -1)\n            .toArray();\n    }\n\n    getEvents(timestamp: number): Promise<IRecordEvent[]> {\n        return this.events\n            .orderBy('timestamp').reverse()\n            .filter((it: IRecordEvent) => it?.type === EventType.Meta)\n            .filter((it: IRecordEvent) => it?.timestamp > timestamp)\n            .limit(1)\n            .first()\n            .then((nextSession?: IRecordEvent) => {\n                return this.events\n                    .orderBy('timestamp').reverse()\n                    .filter((it: IRecordEvent) => it?.timestamp >= timestamp\n                        && it?.timestamp < (nextSession?.timestamp ?? Number.MAX_VALUE))\n                    .toArray()\n            })\n    }\n\n    exportSessions(fromDate?: Date, toDate?: Date): Promise<Blob> {\n        return exportDB(this, {\n            filter: (table: string, value: any, key?: any): boolean => {\n                switch (table) {\n                    case 'events':\n                        return (<IRecordEvent>value).timestamp >= (fromDate?.getTime() || Number.MIN_VALUE)\n                            && (<IRecordEvent>value).timestamp <= (toDate?.getTime() || Number.MAX_VALUE);\n                    default:\n                        return false;\n                }\n            }\n        });\n    }\n}\n"],"mappings":"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"}