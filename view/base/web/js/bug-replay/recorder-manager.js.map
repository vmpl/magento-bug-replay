{"version":3,"file":"recorder-manager.js","names":["DataEvent","_Event","_inheritsLoose","apply","arguments","NewSessionWithError","result","instance","Types","bubbles","cancelable","data","UploadSessionFinished","sessions","_createClass","key","get","_wrapNativeSuper","Event","RecorderManager","sessionWorker","paginator","_itemsPaginator","_proto","prototype","startRecord","self","stopRecord","rrweb","record","emit","event","post","then","_result$errors$length","_result$errors","errors","length","window","dispatchEvent","plugins","getRecordConsolePlugin","init","endpoint","urlWorker","URL","location","origin","pathname","WorkerClient","toString","initInstance","downloadImport","request","_this","import","getEventsForSessionAt","events","response","items","uploadSessions","_this2","export","clear","deleteAt","at","_this3","fetch","session","delete","_delete","_this4","loadPaginatorItems","offset","limit","filter","sessionId","PaginatorFilter","append","pop","Object","assign"],"sources":["../../ts/js/bug-replay/recorder-manager.ts"],"sourcesContent":["import {EventPostResult, IRecordEvent, IRecordSession, SessionWorker} from \"VMPL_BugReplay/js/api/session\";\nimport ItemPaginator, {PaginatorFilter} from \"VMPL_BugReplay/js/bug-replay/items-paginator\";\nimport {IPaginatorFilter, IPaginatorLoader, IPaginatorResponse} from \"VMPL_BugReplay/js/api/paginator\";\nimport {WorkerClient} from \"VMPL_BugReplay/js/lib/worker/client\";\nimport {RecordSession} from \"VMPL_BugReplay/js/bug-replay/session/model/record-session\";\nimport {eventWithTime, recordOptions, RecordPlugin} from \"rrweb/typings/types\";\n\ndeclare const rrweb: {record: (options: recordOptions<eventWithTime>) => Function, getRecordConsolePlugin: () => RecordPlugin };\n\nexport class DataEvent extends Event {\n    data: any;\n\n    static get Types() {\n        return  {\n            NewSessionWithError: 'vmpl-new-session-with-error',\n            UploadSessionFinished: 'vmpl-upload-session-finished',\n        }\n    }\n\n    static NewSessionWithError(result: EventPostResult): DataEvent {\n        const instance = new this(DataEvent.Types.NewSessionWithError, {bubbles: false, cancelable: false});\n        instance.data = result;\n        return instance;\n    }\n\n    static UploadSessionFinished(sessions: IRecordSession[]): DataEvent {\n        const instance = new this(DataEvent.Types.UploadSessionFinished, {bubbles: false, cancelable: false});\n        instance.data = sessions;\n        return instance;\n    }\n}\n\nexport default class RecorderManager implements IPaginatorLoader<IRecordSession> {\n    readonly paginator: ItemPaginator<RecordSession, RecorderManager>;\n    stopRecord: Function;\n\n    protected constructor(\n        protected readonly sessionWorker: SessionWorker,\n    ) {\n        this.paginator = new ItemPaginator([], this);\n    }\n\n    startRecord() {\n        ((self) => {\n            self.stopRecord = rrweb.record({\n                emit(event: IRecordEvent) {\n                    self.sessionWorker.post(event)\n                        .then(result => {\n                            (result?.errors?.length ?? 0) === 0\n                                || window.dispatchEvent(DataEvent.NewSessionWithError(result));\n                        })\n                },\n                plugins: [rrweb.getRecordConsolePlugin()],\n            })\n        })(this);\n    }\n\n    static init(endpoint: string, instance: string = 'BugReplay'): Promise<RecorderManager> {\n        const urlWorker = new URL(location.origin);\n        urlWorker.pathname = `${endpoint}/VMPL_BugReplay/js/bug-replay/session/worker`;\n\n        return WorkerClient<SessionWorker>(urlWorker.toString())\n            .then((sessionWorker: SessionWorker) => {\n                return sessionWorker.initInstance(instance)\n                    .then(() => new RecorderManager(sessionWorker))\n            })\n    }\n\n    downloadImport(request: URL): Promise<RecorderManager> {\n        return this.sessionWorker.import(request.toString())\n            .then(() => this);\n    }\n\n    getEventsForSessionAt(sessions: IRecordSession[]): Promise<IRecordEvent[]> {\n        return this.sessionWorker.events(sessions)\n            .then(response => response.items);\n    }\n\n    uploadSessions(sessions: IRecordSession[]): Promise<void> {\n        return this.sessionWorker.export(sessions)\n            .then(() => this.paginator.clear())\n            .then(() => window.dispatchEvent(DataEvent.UploadSessionFinished(sessions)))\n            .then();\n    }\n\n    deleteAt(at: number): Promise<void> {\n        return this.paginator.fetch(at)\n            .then(session => this.delete([session]));\n    }\n\n    delete(sessions: RecordSession[]): Promise<void> {\n        return this.sessionWorker.delete(sessions)\n            .then(() => this.paginator.clear());\n    }\n\n    loadPaginatorItems(\n        offset: number,\n        limit: number,\n        filter: IPaginatorFilter<IRecordSession>,\n    ): Promise<IPaginatorResponse<RecordSession>> {\n        return this.sessionWorker.sessions(offset, limit, filter);\n    }\n\n    session(sessionId: number): Promise<IRecordSession> {\n        const filter = new PaginatorFilter<IRecordSession>();\n        filter.append(new PaginatorFilter<IRecordSession>('id', sessionId));\n\n        return this.sessionWorker.sessions(0, 1, filter)\n            .then(items => items.items.pop());\n    }\n}\n"],"mappings":"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"}