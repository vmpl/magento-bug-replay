{"version":3,"file":"session-worker.js","names":["_sessionDatabase","_interopRequireDefault","_workerSerializer","obj","__esModule","default","SessionWorker","_proto","prototype","exportToObject","initInstance","bind","post","sessions","instance","database","SessionDatabase","Promise","resolve","event","postRecord","then","offset","limit","filter","getFullSnapshotsWithMeta","items","reduce","accumulator","currentValue","_accumulator$pop","snapshotMeta","pop","snapshot","meta","push","type","EventType","Meta","FullSnapshot","it","forEach","_tagMetaTitle$attribu","_tagMetaTitle$attribu2","tagMetaTitle","data","node","childNodes","find","tagName","_it$attributes","attributes","name","timestamp","href","title","content","match","totalRecords","length","registerSerializer","WorkerSerializer","sessionWorker","expose"],"sources":["../../../../frontend/web/ts/js/worker/session-worker.ts"],"sourcesContent":["// @ts-ignore\nimport {expose} from 'threads/worker';\nimport {\n    EventType,\n    RecordEvent,\n    SessionWorker as SessionWorkerInterface,\n    SnapshotWithMeta\n} from 'VMPL_BugReplay/js/api/session'\nimport SessionDatabase from \"VMPL_BugReplay/js/lib/session-database\";\nimport {IPaginatorFilter, IPaginatorResponse} from \"VMPL_BugReplay/js/api/paginator\";\nimport {registerSerializer} from \"threads\";\nimport WorkerSerializer from \"VMPL_BugReplay/js/lib/worker-serializer\";\n\nclass SessionWorker implements SessionWorkerInterface {\n    protected database: SessionDatabase;\n\n    exportToObject(): Object {\n        return {\n            initInstance: this.initInstance.bind(this),\n            post: this.post.bind(this),\n            sessions: this.sessions.bind(this),\n        }\n    }\n\n    initInstance(instance: string): Promise<any> {\n        this.database = new SessionDatabase(instance);\n        return Promise.resolve();\n    }\n\n    post(event: RecordEvent): Promise<boolean> {\n        return this.database.postRecord(event)\n            .then(() => true);\n    }\n\n    sessions(offset: number = 0, limit: number, filter: IPaginatorFilter): Promise<IPaginatorResponse> {\n        return this.database.getFullSnapshotsWithMeta()\n            .then(items => {\n                let sessions: any[] = [];\n                items\n                    .reduce<SnapshotWithMeta[]>((accumulator, currentValue) => {\n                        let snapshotMeta: SnapshotWithMeta = accumulator.pop() ?? {snapshot: null, meta: null};\n                        if (snapshotMeta.meta !== null && snapshotMeta.snapshot !== null) {\n                            accumulator.push(snapshotMeta);\n                            snapshotMeta = {snapshot: null, meta: null};\n                        }\n\n                        switch (true) {\n                            case currentValue.type === EventType.Meta && snapshotMeta.meta === null:\n                                snapshotMeta.meta = currentValue;\n                                break;\n                            case currentValue.type === EventType.FullSnapshot && snapshotMeta.snapshot === null:\n                                snapshotMeta.snapshot = currentValue;\n                                break;\n                            default:\n                                break;\n                        }\n\n                        accumulator.push(snapshotMeta);\n                        return accumulator;\n                    }, [])\n                    .filter(it => !(it.meta === null || it.snapshot === null))\n                    .forEach((snapshotMeta: SnapshotWithMeta) => {\n                        const tagMetaTitle = snapshotMeta.snapshot.data.node\n                            .childNodes.find((it: any) => it.tagName === 'html')\n                            .childNodes.find((it: any) => it.tagName === 'head')\n                            .childNodes.find((it: any) => it.attributes?.name === 'title')\n\n                        sessions.push({\n                            timestamp: snapshotMeta.meta.timestamp,\n                            href: snapshotMeta.meta.data.href,\n                            title: tagMetaTitle?.attributes?.content ?? 'Unknown',\n                        })\n                    })\n\n                sessions = filter.match(sessions);\n                return {\n                    meta: {totalRecords: sessions.length},\n                    items: sessions\n                }\n            })\n    }\n}\nregisterSerializer(WorkerSerializer);\n\nconst sessionWorker = new SessionWorker();\nexpose(sessionWorker.exportToObject());\n"],"mappings":"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"}