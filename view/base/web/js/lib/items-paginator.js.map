{"version":3,"file":"items-paginator.js","names":["CompareTypes","CompareType","_dec","WorkerArgument","module","id","_class","type","equal","_proto","prototype","match","item","against","in","includes","less","more","regex","test","Error","PaginatorFilter","_dec2","_class2","property","value","compare","and","groups","undefined","_proto2","append","_this$groups","push","apply","arguments","items","filter","matchItem","bind","groupsMatched","map","it","hasOwnProperty","toString","getItemValue","propertyComponents","split","itemProperty","shift","itemValue","length","join","_default","loader","_filter","_page","_size","_proto3","loadPage","_this","offset","limit","slice","loadPaginatorItems","then","response","Array","meta","totalRecords","forEach","index","Promise","resolve","fetch","atIndex","_this2","page","Number","toFixed","clear","each","_this3","next","all","_this4","getPage","_this5","Exception","Finish","_createClass","key","get","set","_Error","_inheritsLoose","_wrapNativeSuper","Object","assign"],"sources":["../../ts/js/lib/items-paginator.ts"],"sourcesContent":["import {\n    ICompare, IPaginatorFilter,\n    IPaginatorLoader,\n} from \"VMPL_BugReplay/js/api/paginator\";\nimport * as module from \"module\";\nimport {WorkerArgument} from \"VMPL_BugReplay/js/lib/worker/decorator\";\nimport {of} from \"rxjs\";\nimport {ArrayTypeAnnotation} from \"@babel/types\";\n\nenum CompareTypes {\n    equal,\n    in,\n    less,\n    more,\n    regex,\n}\n\n@WorkerArgument(module.id)\nexport class CompareType implements ICompare {\n    constructor(\n        protected readonly type: CompareTypes = CompareTypes.equal,\n    ) {\n        this.type = type;\n    }\n\n    match(item: any, against: any): boolean {\n        switch (this.type) {\n            case CompareTypes.equal:\n                return item == against;\n            case CompareTypes.in:\n                return against.includes(item);\n            case CompareTypes.less:\n                return item < against;\n            case CompareTypes.more:\n                return item > against;\n            case CompareTypes.regex:\n                return (<RegExp>against).test(<string>item);\n            default:\n                throw new Error(`Case not implemented: ${this.type}`);\n        }\n    }\n}\n\n@WorkerArgument(module.id)\nexport class PaginatorFilter<T extends Object> implements IPaginatorFilter<T> {\n    constructor(\n        public property: PropertyKey = null,\n        public value: any = undefined,\n        public compare: ICompare = new CompareType(CompareTypes.equal),\n        public and: boolean = true,\n        protected groups: PaginatorFilter<T>[] = [],\n    ) {\n    }\n\n    append(...filters: PaginatorFilter<T>[]): PaginatorFilter<T> {\n        this.groups.push(...filters);\n        return this;\n    }\n\n    match(items: Array<T>): Array<T> {\n        return items.filter(this.matchItem.bind(this));\n    }\n\n    protected matchItem(item: Object): boolean {\n        const groupsMatched: Array<boolean> = this.groups.map(it => it.matchItem(item));\n        if (this.property) {\n            if (!item.hasOwnProperty(this.property)) {\n                throw new Error(`item do not have property named: ${this.property.toString()}`)\n            }\n            groupsMatched.push(this.compare.match(this.getItemValue(item, this.property), this.value));\n        }\n\n        return this.and\n            ? !groupsMatched.includes(false)\n            : groupsMatched.includes(true);\n    }\n\n    protected getItemValue(item: any, property: PropertyKey): any {\n        const propertyComponents = (<string>property).split('.');\n        const itemProperty = propertyComponents.shift();\n\n        const itemValue = item.hasOwnProperty(itemProperty) ? item[itemProperty] : undefined;\n        return propertyComponents.length === 0 ? itemValue : this.getItemValue(itemValue, propertyComponents.join('.'));\n    }\n}\n\nexport default class<T extends Object, L extends IPaginatorLoader<T>> {\n    protected readonly _filter: PaginatorFilter<T> = new PaginatorFilter();\n    protected _page: number = 1;\n    protected _size: number = 5;\n\n    set page(value: number) {\n        if (!(value > 0)) {\n            throw new Error(`Page cannot be lower then 1, given ${value}`);\n        }\n\n        this._page = value;\n    }\n\n    get page(): number {\n        return this._page;\n    }\n\n    set size(value: number) {\n        if (value <= 0) {\n            throw new Error('Size have to be greater then 0.');\n        }\n        if (this.items.length && this.items.length > value) {\n            throw new Error('Size is greater then records found');\n        }\n\n        this._size = value;\n    }\n\n    set filter(value: PaginatorFilter<T>) {\n        this.page = 1;\n        this.items = [];\n        this._filter.append(value);\n    }\n\n    constructor(\n        protected items: Array<T>,\n        protected readonly loader: L,\n    ) {\n    }\n\n    protected loadPage(): Promise<void> {\n        const offset = (this._page - 1) * this._size;\n        const limit = offset + this._size;\n\n        // @ts-ignore\n        if (!this.items.length || this.items.slice(offset, limit).includes()) {\n            return this.loader.loadPaginatorItems(offset, this._size, this._filter)\n                .then(response => {\n                    this.items.length\n                        || (this.items = new Array(response.meta.totalRecords));\n\n                    response.items.forEach((item, index) => {\n                        this.items[offset + index] = item;\n                    })\n                })\n        }\n\n        return Promise.resolve();\n    }\n\n    fetch(atIndex: number): Promise<T> {\n        this.page = Number((atIndex / this._size).toFixed()) + 1;\n        return this.loadPage()\n            .then(() => this.items[atIndex]);\n    }\n\n    clear() {\n        this._page = 1;\n        this.items = [];\n    }\n\n    forEach(each?: (item: T, index: number) => void): Promise<void> {\n        let index = 0;\n        const next: () => Promise<void> = () => {\n            return this.fetch(index++)\n                .then(it => !each || each(it, index))\n                .then(() => {\n                    if (index < this.items.length) {\n                        return next();\n                    }\n                })\n        };\n\n        return next();\n    }\n\n    all(): Promise<T[]> {\n        return this.forEach()\n            .then(() => this.items);\n    }\n\n    getPage(): Promise<T[]> {\n        const offset = (this._page - 1) * this._size;\n        const limit = offset + this._size;\n\n        return this.loadPage()\n            .then(() => {\n                const items = this.items.slice(offset, limit);\n                if (!items.length) {\n                    throw Exception.Finish();\n                }\n                return items;\n            })\n    }\n}\n\nexport class Exception extends Error {\n    static Finish() {\n        return new this('Finish');\n    }\n}\n"],"mappings":"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"}