{"version":3,"file":"list.js","names":["_default","_uiComponent","extend","listOpen","_knockout","observable","sessions","observableArray","itemComponents","defaults","template","exports","itemConfig","component","config","provider","children","options","displayArea","initObservable","_super","loadFirst","_this","listSubscribe","subscribe","slice","shift","itemActive","item","dispose","reload","_this2","forEach","it","destroy","removeAll","_data","manager","then","paginator","clear","elementLoading","hidden","dynamicLoad","_this3","getPage","_this3$sessions","itemSessions","map","ItemSessionFactory","create","push","apply","Promise","all","mapItemComponent","bind","items","_this3$itemComponents","page","isInViewport","catch","error","ItemPaginatorException","afterLoading","element","elementLoadingObserver","IntersectionObserver","root","parentElement","threshold","observe","listElement","closest","conteinerElement","rect","getBoundingClientRect","top","left","bottom","window","innerHeight","document","documentElement","clientHeight","right","innerWidth","clientWidth","itemSession","componentConfig","structuredClone","name","id","itemIndex","indexOf","_uiLayout","_uiRegistry","promise"],"sources":["../../ts/js/view/list.ts"],"sourcesContent":["// @ts-ignore\nimport layout from 'uiLayout';\nimport registry from \"uiRegistry\";\nimport Component from 'uiComponent';\nimport ko from 'knockout';\nimport Data from 'VMPL_BugReplay/js/model/data';\nimport ItemSession, {ItemSessionFactory} from \"VMPL_BugReplay/js/model/item-session\";\nimport {Exception as ItemPaginatorException} from \"VMPL_BugReplay/js/lib/items-paginator\";\n\nexport default Component.extend({\n    listOpen: ko.observable(false),\n    sessions: ko.observableArray<ItemSession>([]),\n    itemComponents: ko.observableArray([]),\n    defaults: {\n        template: 'VMPL_BugReplay/player/list',\n        exports: {\n            sessions: '${ $.provider }:sessions',\n        },\n        itemConfig: {\n            component: 'VMPL_BugReplay/js/view/list-item',\n            config: {\n                provider: '${ $.provider }',\n            },\n            children: {\n                options: {\n                    component: 'uiComponent',\n                    displayArea: 'options',\n                    children: {}\n                }\n            }\n        },\n    },\n    initObservable() {\n        this._super();\n        this.loadFirst();\n        return this;\n    },\n    loadFirst() {\n        const listSubscribe = this.itemComponents.subscribe(() => {\n            const component = this.itemComponents.slice(0, 1).shift();\n            component.itemActive(component.item);\n\n            listSubscribe.dispose()\n        });\n    },\n    reload() {\n        this.itemComponents().forEach((it: any) => it.destroy());\n        this.sessions.removeAll();\n        this.itemComponents.removeAll();\n        this.loadFirst();\n\n        return Data.manager\n            .then(manager => manager.paginator.clear())\n            .then(() => (this.elementLoading.hidden = false));\n    },\n    dynamicLoad(): Promise<void> {\n        return Data.manager\n            .then(manager => manager.paginator.getPage()\n                .then(sessions => {\n                    const itemSessions = sessions.map(it => ItemSessionFactory.create(it));\n                    this.sessions.push(...itemSessions);\n\n                    return Promise.all(itemSessions.map(this.mapItemComponent.bind(this)))\n                })\n                .then(items => {\n                    manager.paginator.page++\n                    this.itemComponents.push(...items);\n                })\n                .then(() => {\n                    !this.isInViewport()\n                        || this.dynamicLoad();\n                })\n                .catch(error => {\n                    if (error instanceof ItemPaginatorException) {\n                        this.elementLoading.hidden = true;\n                        return;\n                    }\n\n                    throw error;\n                }))\n\n    },\n    afterLoading(element: HTMLUListElement) {\n        if (!this.elementLoading) {\n            this.elementLoading = element;\n            this.elementLoadingObserver = new IntersectionObserver(\n                this.dynamicLoad.bind(this),\n                {root: this.elementLoading.parentElement, threshold: 0.5}\n            )\n            this.elementLoadingObserver.observe(this.elementLoading);\n        }\n\n        if (!this.element) {\n            this.element = element;\n            this.listElement = element.closest('.vmpl_session .list');\n            this.conteinerElement = element.closest('.vmpl_session');\n        }\n    },\n    isInViewport() {\n        const rect = this.elementLoading.getBoundingClientRect();\n        return (\n            !this.elementLoading.hidden\n            && rect.top >= 0\n            && rect.left >= 0\n            && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)\n            && rect.right <= (window.innerWidth || document.documentElement.clientWidth)\n        )\n    },\n    mapItemComponent(itemSession: ItemSession) {\n        const componentConfig = structuredClone(this.itemConfig);\n        componentConfig.name = `${this.name}.item_${itemSession.id}`;\n        componentConfig.itemIndex = this.sessions.indexOf(itemSession);\n\n        layout([componentConfig]);\n        return registry.promise(componentConfig.name)\n    }\n});\n"],"mappings":"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"}